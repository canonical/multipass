parts:
  inject-apt-mirrors:
    plugin: nil
    override-pull: |
      # Based on https://github.com/actions/runner-images/blob/main/images/ubuntu/scripts/build/configure-apt-sources.sh
      echo "Injecting custom APT mirror priorities..."

      cat <<EOF > /etc/apt/apt-mirrors.txt
      http://azure.archive.ubuntu.com/ubuntu/	priority:1
      https://archive.ubuntu.com/ubuntu/	priority:2
      https://security.ubuntu.com/ubuntu/	priority:3
      EOF

      codename=jammy
      cat <<EOF > /etc/apt/sources.list
      deb mirror+file:/etc/apt/apt-mirrors.txt $codename main restricted universe multiverse
      deb mirror+file:/etc/apt/apt-mirrors.txt $codename-updates main restricted universe multiverse
      deb mirror+file:/etc/apt/apt-mirrors.txt $codename-security main restricted universe multiverse
      EOF

      apt-get update