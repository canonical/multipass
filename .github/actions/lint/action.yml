name: Lint
description: Run Linting steps

runs:
  using: composite
  steps:
  - name: Initialize and update submodules
    shell: bash
    run: |
      set -e -o pipefail
      git submodule update --init --recursive
      
  - name: Check for forbidden tag in code
    shell: bash
    run: |
      set -e -o pipefail
      forbidden_regex='(?i)\bno[_-]?merge\b'
      added_regex="^\+.*${forbidden_regex}"
      git diff -U0 --no-color HEAD^1 -- . ':(exclude)bors.toml' |
        (grep -P "${added_regex}" || true) |
        tee ${HOME}/forbidden_occurrences
      if [ "$( stat --printf='%s' ${HOME}/forbidden_occurrences )" -ne 0 ]; then
        echo "##[error] Forbidden string(s) found in the diff ^ (matched \"$added_regex\")"
        exit 1
      fi

  - name: Check whitespace
    uses: ./.github/actions/whitespace

  - name: Check final newline
    uses: qwrtln/check-final-newline@v1.0.0

  - name: Install clang-format
    shell: bash
    run: sudo apt-get install --no-install-recommends --yes clang-format-16

  - name: Run clang-format through the diff
    shell: bash
    run: |
      set -e -o pipefail
      git diff -U0 --no-color HEAD^1 | clang-format-diff-16 -p1 | tee ${HOME}/clang-diff
      if [ "$( stat --printf='%s' ${HOME}/clang-diff )" -ne 0 ]; then
        echo "##[error] Please apply the above diff to correct formatting"
        exit 1
      fi

  - name: Verify Flutter installation
    shell: bash
    run: |
      set -e -o pipefail
      if [ ! -f "3rd-party/flutter/bin/dart" ]; then
        echo "##[error] Flutter submodule not found or not properly initialized"
        echo "##[error] Please ensure you have run 'git submodule update --init --recursive'"
        exit 1
      fi

  - name: Run Flutter format check
    shell: bash
    run: |
      set -e -o pipefail
      if [ ! -d "3rd-party/flutter" ]; then
        echo "##[warning] Flutter directory not found, skipping Flutter format check"
        exit 0
      fi
      if ! 3rd-party/flutter/bin/dart format --output=none --set-exit-if-changed .; then
        echo "##[error] Flutter code is not properly formatted."
        echo "##[error] Please run '3rd-party/flutter/bin/dart format' to fix formatting"
        exit 1
      fi