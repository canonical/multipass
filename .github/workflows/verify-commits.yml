name: Verify Commits

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  CheckCommits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify commit messages
        run: |
          set -e -o pipefail

          # Get the base and head commits for the PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          COUNTER=1

          # loop over all commits in the PR (excluding merge base)
          git rev-list --reverse $BASE_SHA..$HEAD_SHA | while read -r COMMIT_SHA; do
            echo "-- Verifying commit $COUNTER: $COMMIT_SHA --"
            ./git-hooks/commit-msg.py - <<< $(git log -n1 --format=%B $COMMIT_SHA | head -c -1)

            COUNTER=$((COUNTER + 1))
          done
