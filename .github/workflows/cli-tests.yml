name: CLI Tests

on:
  push:
  workflow_call:

permissions:
  contents: read

concurrency:
  group: cli-tests-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  run-cli-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out cli-tests
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          submodules: false
          sparse-checkout: |
            tools/cli_tests

      - name: Install cli-tests dependencies
        id: install-cli-test-deps
        run: sudo pip install -e ./tools/cli_tests/ --break-system-packages

      - name: Install snap
        id: install-snap
        run: sudo snap install multipass --channel=beta

      - name: Run cli-tests
        id: run-cli-tests
        run: pytest -s tools/cli_tests --remove-all-instances --print-cli-output  --daemon-controller=snap -vv
