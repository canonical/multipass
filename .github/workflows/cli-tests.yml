name: CLI Tests

on:
  workflow_call:
    inputs:
      snap-channel:
        type: string
        description: "Snap channel to install Multipass from"
        required: false
  workflow_dispatch:
    inputs:
      snap-channel:
        type: string
        description: "Snap channel to install Multipass from"
        required: false

permissions:
  contents: read
  actions: read
  checks: write

concurrency:
  group: cli-tests-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  run-cli-tests-for-snap:
    if: ${{ contains(keys(inputs), 'snap-channel') }}
    name: CLI Tests (Snap)
    runs-on: ubuntu-latest
    steps:
      - name: Validate snap-channel
        if: ${{ !cancelled() }}
        run: |
          if [ -z "${{ inputs.snap-channel }}" ]; then
            echo "‚ùå snap-channel is empty"
            exit 1
          fi
      - name: Check out cli-tests
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          submodules: false
          sparse-checkout: |
            tools/cli_tests

      - name: Install cli-tests dependencies
        id: install-cli-test-deps
        run: sudo pip install -e ./tools/cli_tests/ --break-system-packages

      - name: Install snap
        id: install-snap
        run: sudo snap install multipass --channel=${{ inputs['snap-channel'] }}

      - name: Run cli-tests
        id: run-cli-tests
        run: pytest -s tools/cli_tests --remove-all-instances --daemon-controller=snap --junitxml=reports/junit.xml

      - name: Report cli-tests results to Github Checks
        if: success() || failure()
        uses: dorny/test-reporter@v2
        with:
          name: CLI Test results (Snap, ${{ runner.os }})
          path: reports/junit.xml
          reporter: java-junit # understands standard JUnit
          fail-on-error: true # fail job if there are test failures
